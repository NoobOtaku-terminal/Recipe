# Production overrides for docker-compose.yml
# Usage: docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
#
# Resource Allocation for Azure VM: 2 CPU, 1 GiB RAM
# - Postgres:  0.8 CPU, 350MB (database priority)
# - Backend:   0.6 CPU, 350MB (API processing)
# - Frontend:  0.3 CPU, 150MB (static files)
# - Nginx:     0.3 CPU, 150MB (reverse proxy)
# Total:       2.0 CPU, 1000MB (~150MB reserved for OS/migrations)

services:
  postgres:
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}  # Must be set in .env
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./database/init:/docker-entrypoint-initdb.d:ro
      # Remove seeds volume for production
      # Remove seeds volume for production
    deploy:
      resources:
        limits:
          cpus: '0.8'
          memory: 350M
        reservations:
          cpus: '0.4'
          memory: 200M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  migrations:
    build:
      context: ./database
      dockerfile: Dockerfile.migrations.prod
    environment:
      NODE_ENV: production
      SEED_DATABASE: 'false'
    volumes:
      - ./database/migrations:/migrations:ro
      # Remove seeds volume for production
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  backend:
    environment:
      NODE_ENV: production
      LOG_LEVEL: info
    deploy:
      # Note: replicas require Docker Swarm mode
      # For single server, use 1 replica or remove container_name from base config
      # replicas: 2
      resources:
        limits:
          cpus: '0.6'
          memory: 350M
        reservations:
          cpus: '0.3'
          memory: 200M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  frontend:
    deploy:
      resources:
        limits:
          cpus: '0.3'
          memory: 150M
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  nginx:
    ports:
      - "80:80"
      - "443:443"
    deploy:
      resources:
        limits:
          cpus: '0.3'
          memory: 150M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  postgres_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /data/postgres_data
  media_uploads:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /data/media_uploads
